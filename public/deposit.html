<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Deposit via Flutterwave (Mobile Money Rwanda)</title>
  <style>
    :root { --bg:#0f172a; --card:#111827; --muted:#94a3b8; --text:#e5e7eb; --ok:#16a34a; --warn:#ca8a04; --err:#dc2626; --accent:#6366f1; }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: system-ui, Arial, sans-serif; background: linear-gradient(180deg,#0b1024,#0f172a 30%,#0f172a); color: var(--text); }
    .wrap { max-width: 560px; margin: 48px auto; padding: 0 16px; }
    .card { background: rgba(17,24,39,.7); backdrop-filter: blur(8px); border: 1px solid rgba(148,163,184,.15);
            border-radius: 16px; padding: 22px; box-shadow: 0 20px 40px rgba(0,0,0,.35); }
    h1 { margin: 0 0 8px; font-size: 1.5rem; letter-spacing: .2px; }
    p.lead { margin: 0 0 18px; color: var(--muted); }
    label { display:block; font-size:.9rem; margin:14px 0 6px; color:#cbd5e1; }
    input, select { width:100%; padding:12px 14px; border-radius:12px; border:1px solid rgba(148,163,184,.25);
      background:#0b1220; color:var(--text); outline:none; }
    input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(99,102,241,.15); }
    .row { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    .btn { width:100%; padding:12px 16px; border:0; border-radius:12px; background:var(--accent); color:white;
           font-weight:600; cursor:pointer; margin-top:16px; }
    .btn:disabled { opacity:.6; cursor:not-allowed; }
    .note { font-size:.85rem; color: var(--muted); margin-top:8px; }
    .status { margin-top:16px; padding:12px; border-radius:12px; border:1px dashed rgba(148,163,184,.25); font-size:.95rem; }
    .status.ok { border-color: rgba(22,163,74,.5); color:#bbf7d0; }
    .status.warn { border-color: rgba(202,138,4,.5); color:#fde68a; }
    .status.err { border-color: rgba(220,38,38,.5); color:#fecaca; }
    .pill { display:inline-block; padding:2px 8px; border-radius:999px; background:#0b1220; border:1px solid rgba(148,163,184,.25); font-size:.78rem; color:#cbd5e1; margin-left:6px; }
    .footer { text-align:center; margin-top:18px; font-size:.8rem; color:#94a3b8; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Deposit (MoMo Rwanda)</h1>
      <p class="lead">
        Enter the amount and your MTN/Airtel Rwanda phone number. You’ll get a PIN prompt on your phone to confirm.
        <span class="pill">Currency: RWF</span>
      </p>

      <form id="deposit-form">
        <label for="user_id">User ID</label>
        <input id="user_id" name="user_id" type="number" min="1" value="1" required />

        <div class="row">
          <div>
            <label for="amount">Amount (RWF)</label>
            <input id="amount" name="amount" type="number" min="100" step="1" placeholder="e.g. 1000" required />
          </div>
          <div>
            <label for="phone_number">Phone Number (with country code)</label>
            <input id="phone_number" name="phone_number" type="tel" inputmode="numeric"
                   placeholder="250783495170" required />
          </div>
        </div>

        <div class="note">
          Format: <strong>2507XXXXXXXX</strong> (Rwanda). The payment is collected to your Flutterwave merchant
          account; your target owner reference is <strong>0783495170</strong>.
        </div>

        <button class="btn" id="payBtn" type="submit">Deposit Now</button>

        <div id="status" class="status warn" style="display:none;"></div>
      </form>

      <div class="footer">
        Keep this tab open until you confirm the PIN on your phone.
      </div>
    </div>
  </div>

  <script>
    const form = document.getElementById('deposit-form');
    const statusBox = document.getElementById('status');
    const payBtn = document.getElementById('payBtn');

    function showStatus(msg, kind = 'warn') {
      statusBox.textContent = msg;
      statusBox.className = 'status ' + kind;
      statusBox.style.display = 'block';
    }

    function normalizeRwPhone(raw) {
      // Accepts 07XXXXXXXX, +2507XXXXXXXX, 2507XXXXXXXX and normalizes to 2507XXXXXXXX
      const digits = (raw || '').replace(/\D/g, '');
      if (digits.startsWith('07') && digits.length === 10) return '250' + digits;
      if (digits.startsWith('250') && digits.length === 12) return digits;
      if (digits.startsWith('2507') && digits.length === 12) return digits;
      if (digits.startsWith('7') && digits.length === 9) return '250' + digits;
      return digits; // fallback; backend should revalidate as well
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      payBtn.disabled = true;

      const user_id = Number(document.getElementById('user_id').value);
      const amount = Number(document.getElementById('amount').value);
      const phoneInput = document.getElementById('phone_number').value.trim();
      const phone_number = normalizeRwPhone(phoneInput);

      // Basic client checks
      if (!user_id || user_id < 1) {
        showStatus('Invalid user id.', 'err'); payBtn.disabled = false; return;
      }
      if (!amount || amount < 100) {
        showStatus('Amount should be at least 100 RWF.', 'err'); payBtn.disabled = false; return;
      }
      if (!/^2507\d{8}$/.test(phone_number)) {
        showStatus('Phone must be in format 2507XXXXXXXX (Rwanda).', 'err'); payBtn.disabled = false; return;
      }

      showStatus('Sending deposit request… watch your phone for the PIN prompt.', 'warn');

      try {
        const res = await fetch('/deposit', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ user_id, amount, phone_number })
        });

        // Flutterwave returns a JSON body; your backend forwards it
        const data = await res.json().catch(() => ({}));

        if (!res.ok) {
          const message = (data && (data.message || data.error)) || 'Deposit request failed.';
          showStatus(message, 'err');
          payBtn.disabled = false;
          return;
        }

        // Helpful hints from FW response (gracefully handled if missing)
        const txRef = data?.data?.tx_ref || data?.tx_ref || '';
        const flwRef = data?.data?.flw_ref || data?.flw_ref || '';
        const processorResp = data?.data?.processor_response || '';

        let msg = 'Request sent. Check your phone and enter your MoMo PIN to confirm.';
        if (processorResp) msg += ` (${processorResp})`;
        if (txRef) msg += ` | tx_ref: ${txRef}`;
        if (flwRef) msg += ` | flw_ref: ${flwRef}`;

        showStatus(msg, 'ok');

      } catch (err) {
        showStatus('Network/Server error. Please try again.', 'err');
      } finally {
        // Keep disabled briefly to prevent spam clicks, then re-enable
        setTimeout(() => (payBtn.disabled = false), 2000);
      }
    });
  </script>
</body>
</html>
